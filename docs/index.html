<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TNBL Documentation – Public APIs, Functions, and Components</title>
<style>
:root{
  --bg:#0b0f12; --card:#11161b; --ink:#e6f7f3; --muted:#9bb3ad; --mint:#00f5d4; --line:#1a2329;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font: 15px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background:var(--bg); color:var(--ink);
}
.container{max-width:980px; margin:0 auto; padding:22px 16px}
.card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:18px}
h1,h2,h3{margin:0; margin-top:18px}
h1{font-size:28px}
h2{font-size:20px; margin-top:26px; padding-top:6px; border-top:1px solid var(--line)}
h3{font-size:16px; color:#cfe9e3}
a{color:var(--mint); text-decoration:none}
a:hover{text-decoration:underline}
code{background:#0f1418; color:#cfe9e3; padding:1px 6px; border-radius:6px; border:1px solid var(--line)}
pre{background:#0f1418; color:#cfe9e3; padding:12px; border-radius:10px; border:1px solid var(--line); overflow:auto}
kbd{background:#0f1418; border:1px solid var(--line); padding:2px 6px; border-radius:6px}
.table{width:100%; border-collapse:collapse; margin:10px 0}
.table th,.table td{border:1px solid var(--line); padding:8px; text-align:left; vertical-align:top}
.badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#0f1418; border:1px solid var(--line); color:#9ad6cc; font-weight:700; font-size:12px}
.muted{color:#9bb3ad}
ul{margin:8px 0 8px 18px}
.toc li{margin:3px 0}
hr{border:none; border-top:1px solid var(--line); margin:18px 0}
.small{font-size:12px}
.footer{margin-top:24px; color:#9bb3ad}
</style>
</head>
<body>
  <div class="container">
    <h1>TNBL – Public APIs, Functions, and Components</h1>
    <div class="muted">Mobile‑first dark UI (Neon Mint). This document describes the in-page APIs available in the TNBL demo app.</div>

    <h2>Table of contents</h2>
    <ol class="toc">
      <li><a href="#overview">Overview</a></li>
      <li><a href="#data-model">Data model and storage keys</a></li>
      <li><a href="#utilities">Utilities</a></li>
      <li><a href="#identity-profile">Identity & Profile</a></li>
      <li><a href="#thread-meta">Thread meta</a></li>
      <li><a href="#data-io">Data I/O (localStorage)</a></li>
      <li><a href="#filters">Discover filters</a></li>
      <li><a href="#request-ui">Request UI</a></li>
      <li><a href="#drag-scroll">Drag-to-scroll</a></li>
      <li><a href="#lists">Active & Discover UI</a></li>
      <li><a href="#chat-ui">Chat UI</a></li>
      <li><a href="#nav-badges">Navigation badges</a></li>
      <li><a href="#ads">Ads (device scoped)</a></li>
      <li><a href="#tabs">Tabbar navigation</a></li>
      <li><a href="#touch">Touch ripple</a></li>
      <li><a href="#bubbles">Chat bubble emphasis</a></li>
      <li><a href="#swipe">Swipe between tabs</a></li>
      <li><a href="#dummies">Demo activity dummies</a></li>
      <li><a href="#boot">Boot sequence</a></li>
      <li><a href="#components">Components (HTML/CSS)</a></li>
      <li><a href="#examples">Examples</a></li>
    </ol>

    <h2 id="overview">Overview</h2>
    <p>
      TNBL is a single-file demo SPA using <code>localStorage</code> as its backing store.
      Public APIs are exposed as global functions attached to the window scope by virtue of being defined in the main script.
      You can invoke them from the browser console for testing and automation.
    </p>

    <h2 id="data-model">Data model and storage keys</h2>
    <table class="table">
      <thead><tr><th>Key</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td><code>tnbl:userId</code></td><td>string</td><td>Device-scoped user identity (e.g., <code>user_abc123</code>).</td></tr>
        <tr><td><code>tnbl:me</code></td><td>object</td><td>Profile: <code>{name, gender, age, state, bio}</code>.</td></tr>
        <tr><td><code>tnbl:users</code></td><td>array</td><td>Seeded users catalog.</td></tr>
        <tr><td><code>tnbl:thread:{pair}</code></td><td>array</td><td>Messages for a pair (ordered). Pair key is <code>userA__userB</code> (sorted).</td></tr>
        <tr><td><code>tnbl:meta:{pair}</code></td><td>object</td><td>Thread meta: <code>{accepted, requested, unread, lastReadTs}</code>.</td></tr>
        <tr><td><code>tnbl:adOff</code></td><td>"1"|undefined</td><td>Ads toggle flag (per device).</td></tr>
      </tbody>
    </table>

    <h2 id="utilities">Utilities</h2>

    <h3><code>$</code></h3>
    <div class="badge">function</div>
    <p>Shorthand for <code>document.querySelector</code>.</p>
    <p><strong>Signature</strong>: <code>$(selector: string): Element|null</code></p>

    <h3><code>$$</code></h3>
    <div class="badge">function</div>
    <p>Shorthand for <code>Array.from(document.querySelectorAll)</code>.</p>
    <p><strong>Signature</strong>: <code>$$(selector: string): Element[]</code></p>

    <h3><code>uuid</code></h3>
    <div class="badge">function</div>
    <p>Generates a random ID using <code>crypto.randomUUID</code> when available, otherwise a time/random fallback.</p>
    <p><strong>Signature</strong>: <code>uuid(): string</code></p>

    <h3><code>nowISO</code></h3>
    <div class="badge">function</div>
    <p>Returns current time in ISO string.</p>
    <p><strong>Signature</strong>: <code>nowISO(): string</code></p>

    <h3><code>timeAgo</code></h3>
    <div class="badge">function</div>
    <p>Formats an ISO timestamp to a concise relative time (e.g., <code>2h ago</code>).</p>
    <p><strong>Signature</strong>: <code>timeAgo(ts: string): string</code></p>

    <h3><code>pairKey</code></h3>
    <div class="badge">function</div>
    <p>Stable key for two user IDs, sorted lexicographically.</p>
    <p><strong>Signature</strong>: <code>pairKey(a: string, b: string): string</code></p>

    <h3><code>show</code></h3>
    <div class="badge">function</div>
    <p>Activates a screen by CSS selector; deactivates others.</p>
    <p><strong>Signature</strong>: <code>show(id: "#screenActive" | "#screenDiscover" | "#screenChat" | "#screenSettings")</code></p>

    <h2 id="identity-profile">Identity & Profile</h2>

    <h3><code>ensureIdentity</code></h3>
    <div class="badge">function</div>
    <p>Returns or creates a device-scoped user ID in <code>localStorage</code>.</p>
    <p><strong>Signature</strong>: <code>ensureIdentity(): string</code></p>

    <h3><code>ME</code></h3>
    <div class="badge">const</div>
    <p>The current device user ID (result of <code>ensureIdentity()</code>).</p>

    <h3><code>PROFILE_KEY</code></h3>
    <div class="badge">const</div>
    <p>Constant for profile storage key (<code>"tnbl:me"</code>).</p>

    <h3><code>getMe</code></h3>
    <div class="badge">function</div>
    <p>Reads current profile object.</p>
    <p><strong>Signature</strong>: <code>getMe(): {name?:string, gender?:string, age?:number, state?:string, bio?:string}</code></p>

    <h3><code>saveMe</code></h3>
    <div class="badge">function</div>
    <p>Persists profile object.</p>
    <p><strong>Signature</strong>: <code>saveMe(profile: object): void</code></p>

    <h3><code>validateProfile</code></h3>
    <div class="badge">function</div>
    <p>Validates presence and constraints for profile fields.</p>
    <p><strong>Signature</strong>: <code>validateProfile(p): {ok: boolean, msg?: string}</code></p>

    <h2 id="thread-meta">Thread meta</h2>

    <h3><code>metaKey</code></h3>
    <div class="badge">function</div>
    <p>Builds the meta storage key for a peer.</p>
    <p><strong>Signature</strong>: <code>metaKey(otherId: string): string</code></p>

    <h3><code>getMeta</code> / <code>setMeta</code></h3>
    <div class="badge">functions</div>
    <p>Gets/sets raw meta object for a peer.</p>
    <p><strong>Signatures</strong>:
      <br><code>getMeta(otherId: string): object</code>
      <br><code>setMeta(otherId: string, meta: object): void</code>
    </p>

    <h3><code>ensureMeta</code></h3>
    <div class="badge">function</div>
    <p>Returns meta with defaults: <code>{accepted, unread, lastReadTs, requested}</code>.</p>
    <p><strong>Signature</strong>: <code>ensureMeta(otherId: string): {accepted:boolean, unread:number, lastReadTs:number, requested:boolean}</code></p>

    <h3><code>acceptChat</code></h3>
    <div class="badge">function</div>
    <p>Marks a chat as accepted; resets unread and request flags and updates UI.</p>
    <p><strong>Signature</strong>: <code>acceptChat(otherId: string): void</code></p>

    <h3><code>leaveChatHard</code> / <code>leaveChat</code></h3>
    <div class="badge">functions</div>
    <p>Hard delete conversation and meta; <code>leaveChat</code> prompts confirmation first.</p>
    <p><strong>Signatures</strong>:
      <br><code>leaveChatHard(otherId: string): void</code>
      <br><code>leaveChat(otherId: string): void</code>
    </p>

    <h3><code>cancelRequest</code> / <code>rejectIncoming</code></h3>
    <div class="badge">functions</div>
    <p>Cancel outgoing request or reject incoming request; clears relevant storage and updates UI.</p>

    <h2 id="data-io">Data I/O (localStorage)</h2>

    <h3><code>seedUsers</code></h3>
    <div class="badge">function</div>
    <p>Appends N random demo users to the catalog and re-renders lists.</p>
    <p><strong>Signature</strong>: <code>seedUsers(n = 20): void</code></p>

    <h3><code>clearUsers</code></h3>
    <div class="badge">function</div>
    <p>Clears users, threads, and meta; re-renders lists and badges.</p>

    <h3><code>listUsers</code></h3>
    <div class="badge">function</div>
    <p>Returns all users sorted by <code>createdAt</code> desc.</p>

    <h3><code>touchSeen</code></h3>
    <div class="badge">function</div>
    <p>Updates a user’s <code>lastSeen</code> to now.</p>

    <h3><code>appendMsg</code></h3>
    <div class="badge">function</div>
    <p>Appends a message to a thread key. Returns full thread array.</p>
    <p><strong>Signature</strong>: <code>appendMsg(key, from, to, content): Message[]</code></p>

    <h3><code>sendMessage</code></h3>
    <div class="badge">function</div>
    <p>Sends a message from <code>ME</code> to peer; sets <code>requested</code> if not accepted; updates badges.</p>
    <p><strong>Signature</strong>: <code>sendMessage(toId: string, content: string): Message[]</code></p>

    <h3><code>pushIncoming</code></h3>
    <div class="badge">function</div>
    <p>Simulates an incoming message; increments unread if chat not focused; updates UI and badges.</p>
    <p><strong>Signature</strong>: <code>pushIncoming(fromId: string, content: string): Message[]</code></p>

    <h3><code>loadThread</code></h3>
    <div class="badge">function</div>
    <p>Loads thread between <code>ME</code> and peer.</p>
    <p><strong>Signature</strong>: <code>loadThread(otherId: string): Message[]</code></p>

    <h2 id="filters">Discover filters</h2>

    <h3><code>getFilters</code></h3>
    <div class="badge">function</div>
    <p>Reads current filter controls.</p>

    <h3><code>clearFilters</code></h3>
    <div class="badge">function</div>
    <p>Clears filter controls and re-renders lists.</p>

    <h3><code>filterUsers</code></h3>
    <div class="badge">function</div>
    <p>Applies gender/state/age filters to a users array.</p>

    <h2 id="request-ui">Request UI</h2>

    <h3><code>openRequest</code> / <code>closeRequest</code></h3>
    <div class="badge">functions</div>
    <p>Opens/closes the request modal and manages <code>requestPeer</code> state.</p>

    <h2 id="drag-scroll">Drag-to-scroll</h2>

    <h3><code>enableDragScroll</code></h3>
    <div class="badge">function</div>
    <p>Enables click-drag vertical scroll on an element (desktop convenience).</p>

    <h2 id="lists">Active & Discover UI</h2>

    <h3><code>activePeers</code> / <code>pendingPeers</code></h3>
    <div class="badge">functions</div>
    <p>Derives active (accepted) and pending peers from users and meta.</p>

    <h3><code>renderLists</code></h3>
    <div class="badge">function</div>
    <p>Renders Active, Pending, and Discover user lists; wires buttons; refreshes badges.</p>

    <h2 id="chat-ui">Chat UI</h2>

    <h3><code>currentPeer</code></h3>
    <div class="badge">variable</div>
    <p>The currently open chat peer (user object) or <code>null</code>.</p>

    <h3><code>openChat</code></h3>
    <div class="badge">function</div>
    <p>Opens chat with a user if accepted; resets unread; updates header and renders messages.</p>
    <p><strong>Signature</strong>: <code>openChat(user: User): void</code></p>

    <h3><code>renderChat</code></h3>
    <div class="badge">function</div>
    <p>Renders the chat log bubbles for <code>currentPeer</code>.</p>

    <h3><code>escapeHtml</code></h3>
    <div class="badge">function</div>
    <p>Escapes HTML special chars for safe rendering.</p>

    <h2 id="nav-badges">Navigation badges</h2>

    <h3><code>unreadTotal</code> / <code>pendingIncomingCount</code></h3>
    <div class="badge">functions</div>
    <p>Aggregates unread count across peers and counts pending incoming requests.</p>

    <h3><code>updateNavBadges</code></h3>
    <div class="badge">function</div>
    <p>Updates the Active tab’s badge to show unread + pending.</p>

    <h2 id="ads">Ads (device scoped)</h2>

    <h3><code>updateAd</code></h3>
    <div class="badge">function</div>
    <p>Toggles visibility of elements with <code>.ad-slot</code> based on <code>tnbl:adOff</code>.</p>

    <h2 id="tabs">Tabbar navigation</h2>

    <h3><code>selectTab</code></h3>
    <div class="badge">function</div>
    <p>Handles transitions between screens, animates slide-in/out, toggles tab active state, and re-renders lists where appropriate.</p>
    <p><strong>Signature</strong>: <code>selectTab(id: "#screenActive" | "#screenDiscover" | "#screenSettings")</code></p>

    <h2 id="touch">Touch ripple</h2>

    <h3><code>makeTouchable</code></h3>
    <div class="badge">function</div>
    <p>Adds ripple and press feedback to matched elements (buttons, tabs, list items, ad slots).</p>

    <h2 id="bubbles">Chat bubble emphasis</h2>

    <h3><code>animateLastBubble</code></h3>
    <div class="badge">function</div>
    <p>Adds pop/flash animation to the last sent/received bubble.</p>
    <p><strong>Signature</strong>: <code>animateLastBubble(role: "me" | "them"): void</code></p>

    <h2 id="swipe">Swipe between tabs</h2>
    <p>Self-invoking module wiring horizontal swipe gestures across <code>Active</code>, <code>Discover</code>, and <code>Profile</code> (skips when Chat/modal active).</p>

    <h2 id="dummies">Demo activity dummies</h2>

    <h3><code>seedActivityDummies</code></h3>
    <div class="badge">function</div>
    <p>Seeds threads to showcase pending incoming, outgoing request, and an accepted chat for demo purposes.</p>

    <h2 id="boot">Boot sequence</h2>

    <h3><code>boot</code></h3>
    <div class="badge">function</div>
    <p>Initializes ads state, renders lists, navigates to Discover, seeds demo activity, and wires touch feedback.</p>
    <p>Bound to <code>DOMContentLoaded</code>.</p>

    <h2 id="components">Components (HTML/CSS)</h2>

    <h3>Screens</h3>
    <ul>
      <li><strong>Active</strong> (<code>#screenActive</code>): accepted and pending chats; accept/reject/leave/open actions.</li>
      <li><strong>Discover</strong> (<code>#screenDiscover</code>): filters and user catalog; tap a user to open request modal.</li>
      <li><strong>Chat</strong> (<code>#screenChat</code>): chat header, log, ad slot, composer.</li>
      <li><strong>Profile</strong> (<code>#screenSettings</code>): edit and save profile; remove ads (demo purchase).</li>
    </ul>

    <h3>Key UI classes</h3>
    <ul>
      <li><code>.card</code>: panel container.</li>
      <li><code>.list-wrap</code> / <code>.user-item</code>: scroll area and list rows.</li>
      <li><code>.chat-log</code>, <code>.bub</code>, <code>.me</code>, <code>.them</code>: chat area and bubbles.</li>
      <li><code>.btn</code>, <code>.btn.mint</code>, <code>.btn.ghost</code>, <code>.btn.sm</code>: buttons.</li>
      <li><code>.chip</code>, <code>.badge</code>: status tokens and unread counts.</li>
      <li><code>.tabbar</code>, <code>.tab</code>: bottom navigation.</li>
      <li><code>.ad-slot</code>: ad placeholders (toggled via <code>updateAd</code>).</li>
    </ul>

    <h3>Theme variables</h3>
    <p class="small muted">Available as CSS variables on <code>:root</code> (e.g., <code>--bg</code>, <code>--mint</code>, <code>--line</code>, etc.).</p>

    <h2 id="examples">Examples</h2>

    <h3>Seed and list users</h3>
    <pre>// Add 10 demo users, then list them
seedUsers(10);
listUsers().slice(0,3);</pre>

    <h3>Start a request and accept</h3>
    <pre>// Pick a user and send a short request message
const u = listUsers()[0];
sendMessage(u.id, "hey—want to chat?");
ensureMeta(u.id); // requested: true

// Simulate the other side sending a request (incoming)
pushIncoming(u.id, "hi—up to talk?");

// Accept the chat and open it
acceptChat(u.id);
openChat(u);</pre>

    <h3>Send and receive messages</h3>
    <pre>// Send a message to the current peer
sendMessage(currentPeer.id, "hello from console");
renderChat();

// Simulate an incoming reply
pushIncoming(currentPeer.id, "hey there!");
renderChat();</pre>

    <h3>Leave or clear data</h3>
    <pre>// Leave current chat without a prompt
leaveChatHard(currentPeer.id);

// Clear all users, threads and meta (resets the demo)
clearUsers();</pre>

    <h3>Filters</h3>
    <pre>// Manually set filters in the UI and re-render
document.querySelector("#fGender").value = "F";
document.querySelector("#fState").value = "CA";
document.querySelector("#fAgeMin").value = "21";
document.querySelector("#fAgeMax").value = "35";
renderLists();</pre>

    <h3>Ads</h3>
    <pre>// Turn ads off and refresh visibility
localStorage.setItem("tnbl:adOff", "1");
updateAd();</pre>

    <hr />
    <div class="footer small">
      Generated documentation for the TNBL demo app. All APIs are available globally within the app page context.
    </div>
  </div>
</body>
</html>

